{% extends 'QuarryIQ/base.html' %}

{% block content %}

<title>Quarry IQ - Admin Portal</title>

<h2>Quarry IQ - Admin Portal</h2>

<table><tr><th class="empty"></th><th class="empty"></th></tr></table>
<table><tr><th class="empty"></th><th class="empty"></th></tr></table>
<table><tr><th class="empty"></th><th class="empty"></th></tr></table>


<div class="table-container" style="max-width: 1800px;">
    <form id="grantAccessForm" method="post">
        {% csrf_token %}
        <table class="table">
            <tbody>
                <tr>
                    <th class="empty" style="vertical-align: middle;">
                        <select id="projectSelect" class="custom-select" name="project_id" style="width: 100%;">
                            {% for project in projects %}
                                <option style="text-align: center;" value="{{ project.project_id }}">{{ project.project_company }} - {{ project.project_name }} - {{ project.project_time_period }}</option>
                            {% endfor %}
                        </select>
                    </th>

                    <td style="vertical-align: middle;" class="empty">
                        <input id="projectIDInput" type="hidden" name="project_id" value="">
                        <input class="btn btn-outline-dark" style="width: 250px;" type="submit" value="Grant Access">
                    </td>

                    <td style="vertical-align: middle;" class="empty">
                         <button id="addNewProject" type="button" class="btn btn-outline-success" style="width: 250px;">Add New Project</button>
                    </td>

                    <td class="empty" style="vertical-align: middle;">
                        <button class="btn btn-outline-danger deleteProject" style="width: 250px;" data-project-id="{{ project.id }}">Delete Project</button>
                    </td>
                </tr>

                <tr><th class="empty"></th></tr>
                <tr><th class="empty"></th></tr>

            </tbody>
        </table>

        <table class="table">
            <thead>
                <tr>
                    <th colspan="5">USER INFORMATION</th>
                </tr>
                <tr>
                    <th style="vertical-align: middle;">Select</th>
                    <th style="vertical-align: middle;">User Group</th>
                    <th style="vertical-align: middle;">First Name</th>
                    <th style="vertical-align: middle;">Last Name</th>
                    <th style="vertical-align: middle;">User Name</th>
                    <th style="vertical-align: middle;">Email Address</th>
                </tr>
            </thead>
            <tbody>
                {% for user_with_groups in users_with_groups %}
                <tr>
                    <td style="vertical-align: middle;">
                        <input type="checkbox" id="{{ user_with_groups.user.username }}" name="user_ids" value="{{ user_with_groups.user.id }}">
                    </td>
                    <td style="vertical-align: middle;">
                        {% for group in user_with_groups.groups %}
                            {{ group.name }}
                        {% endfor %}
                    </td>
                    <td style="vertical-align: middle;">{{ user_with_groups.user.first_name }}</td>
                    <td style="vertical-align: middle;">{{ user_with_groups.user.last_name }}</td>
                    <td style="vertical-align: middle;">{{ user_with_groups.user.username }}</td>
                    <td style="vertical-align: middle;">{{ user_with_groups.user.email }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
</div>


<table><tr><th class="empty"></th><th class="empty"></th></tr></table>
<table><tr><th class="empty"></th><th class="empty"></th></tr></table>
<table><tr><th class="empty"></th><th class="empty"></th></tr></table>
<table><tr><th class="empty"></th><th class="empty"></th></tr></table>
<table><tr><th class="empty"></th><th class="empty"></th></tr></table>
<table><tr><th class="empty"></th><th class="empty"></th></tr></table>
<table><tr><th class="empty"></th><th class="empty"></th></tr></table>
<table><tr><th class="empty"></th><th class="empty"></th></tr></table>

<div class="table-container" style="max-width: 1800px;">
    <table class="table">
        <thead>
            <tr>
                <th style="vertical-align: middle;">Project Company</th>
                <th style="vertical-align: middle;">Project Name</th>
                <th style="vertical-align: middle;">Project Time Period</th>
                <td class="space"></td>
                <th style="vertical-align: middle;">User Group</th>
                <th style="vertical-align: middle;">User Name</th>
            </tr>
        </thead>
        <tbody>
            {% for association in project_user_associations %}
                {% for project in association.projects.all %}
                    <tr>
                        <td style="vertical-align: middle;">{{ project.project_company }}</td>
                        <td style="vertical-align: middle;">{{ project.project_name }}</td>
                        <td style="vertical-align: middle;">{{ project.project_time_period }}</td>
                        <td class="space"></td>
                        <td style="vertical-align: middle;">
                            {% for group in association.user.groups.all %}
                                {{ group.name }}
                                {% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </td>
                        <td style="vertical-align: middle;">{{ association.user.username }}</td>

                        <td style="vertical-align: middle;" class="empty">
                            <form class="deleteAssociationForm" action="{% url 'Delete_Access' association.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-danger" style="width: 250px;">Delete Association</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
</div>



<script>

// Gets project_id for association
document.getElementById('grantAccessForm').addEventListener('submit', function(event) {
    // Get the selected project ID
    const selectedProjectId = document.getElementById('projectSelect').value;

    // Update the hidden input field with the selected project ID
    document.getElementById('projectIDInput').value = selectedProjectId;
});



// Delete Project with confirmation
document.querySelectorAll('.deleteProject').forEach(function(button) {
    button.addEventListener('click', function(event) {
        event.preventDefault(); // Prevent default button behavior

        const projectId = document.getElementById('projectSelect').value; // Get the selected project ID from the select element

        // Check if a project is selected
        if (!projectId) {
            // If no project is selected, alert the user and do nothing
            alert("There is no project to delete.");
            return false;
        }

        // Confirm deletion
        const confirmation = confirm("Are you sure you want to delete this project?");
        if (confirmation) {
            // If user confirms, proceed with deletion
            const form = document.createElement('form'); // Create a new form element
            form.method = 'POST'; // Set the form method to POST
            form.action = '/Delete_Project/' + projectId + '/'; // Set the form action to the delete URL

            const csrfInput = document.createElement('input'); // Create a CSRF token input field
            csrfInput.type = 'hidden'; // Set input type to hidden
            csrfInput.name = 'csrfmiddlewaretoken'; // Set input name to the CSRF token field name
            csrfInput.value = '{{ csrf_token }}'; // Set input value to the CSRF token value
            form.appendChild(csrfInput); // Append CSRF token input field to the form

            document.body.appendChild(form); // Append the form to the document body
            form.submit(); // Submit the form
        } else {
            // If user cancels, do nothing
            return false;
        }
    });
});


// Delete Association with prevent confirmation
document.querySelectorAll('.deleteAssociationForm').forEach(function(form) {
    form.addEventListener('submit', function(event) {
        // Prevent form submission
        event.preventDefault();

        // Confirm deletion
        const confirmation = confirm("Are you sure you want to delete this association?");
        if (confirmation) {
            // If user confirms, submit the form
            this.submit();
        } else {
            // If user cancels, do nothing
            return false;
        }
    });
});


document.getElementById('addNewProject').addEventListener('click', function() {
    window.location.href = "{% url 'New_Project_General_Info' %}";
});


</script>


{% endblock content %}